name: ðŸ§ª Schemachange Dryâ€‘Run

on:
  push:
    branches:
      - keypair
  workflow_dispatch:

jobs:
  dry-run:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install schemachange
        run: |
          pip install --upgrade pip
          pip install schemachange snowflake-connector-python

      - name: Validate env vars
        env:
          SNOWFLAKE_ACCOUNT:               ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER:                  ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PRIVATE_KEY:           ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
          SNOWFLAKE_PRIVATE_KEY_PASSPHRASE: ${{ secrets.SNOWFLAKE_PRIVATE_KEY_PASSPHRASE }}
        run: |
          for v in SNOWFLAKE_ACCOUNT SNOWFLAKE_USER SNOWFLAKE_PRIVATE_KEY SNOWFLAKE_PRIVATE_KEY_PASSPHRASE; do
            if [ -z "${!v}" ]; then
              echo "âŒ Missing $v" && exit 1
            fi
          done

      - name: Write private key
        run: |
          echo "$SNOWFLAKE_PRIVATE_KEY" > key.pem
          chmod 600 key.pem
        env:
          SNOWFLAKE_PRIVATE_KEY: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}

      - name: Dryâ€‘run setup folder
        env:
          SNOWFLAKE_ACCOUNT:             ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER:                ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PRIVATE_KEY_PATH:    key.pem
          SNOWFLAKE_PRIVATE_KEY_PASSPHRASE: ${{ secrets.SNOWFLAKE_PRIVATE_KEY_PASSPHRASE }}
          SNOWFLAKE_ROLE:                ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE:           ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE:            ${{ secrets.SNOWFLAKE_DATABASE }}
        run: |
          schemachange \
            --root-folder snowflake/setup \
            --snowflake-account "$SNOWFLAKE_ACCOUNT" \
            --snowflake-user "$SNOWFLAKE_USER" \
            --private-key-path "$SNOWFLAKE_PRIVATE_KEY_PATH" \
            --private-key-passphrase "$SNOWFLAKE_PRIVATE_KEY_PASSPHRASE" \
            --snowflake-role "$SNOWFLAKE_ROLE" \
            --snowflake-warehouse "$SNOWFLAKE_WAREHOUSE" \
            --snowflake-database "$SNOWFLAKE_DATABASE" \
            --dry-run

      - name: Dryâ€‘run migrations folder
        env: # same env block as above
          SNOWFLAKE_ACCOUNT:             ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER:                ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PRIVATE_KEY_PATH:    key.pem
          SNOWFLAKE_PRIVATE_KEY_PASSPHRASE: ${{ secrets.SNOWFLAKE_PRIVATE_KEY_PASSPHRASE }}
          SNOWFLAKE_ROLE:                ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE:           ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE:            ${{ secrets.SNOWFLAKE_DATABASE }}
        run: |
          schemachange \
            --root-folder snowflake/migrations \
            --snowflake-account "$SNOWFLAKE_ACCOUNT" \
            --snowflake-user "$SNOWFLAKE_USER" \
            --private-key-path "$SNOWFLAKE_PRIVATE_KEY_PATH" \
            --private-key-passphrase "$SNOWFLAKE_PRIVATE_KEY_PASSPHRASE" \
            --snowflake-role "$SNOWFLAKE_ROLE" \
            --snowflake-warehouse "$SNOWFLAKE_WAREHOUSE" \
            --snowflake-database "$SNOWFLAKE_DATABASE" \
            --dry-run
